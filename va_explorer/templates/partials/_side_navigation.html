{% load va_explorer_tags %} {% load static i18n %} {% block css %}
<link rel="stylesheet" href="{% static 'css/sidebar.css' %}" />
{% endblock %}

<!-- Sidebar -->
<div class="sidebar-container" id="sidebar">
  <!-- Toggle Button for Mobile -->
  <button class="sidebar-toggle" id="sidebarToggle" aria-label="Toggle sidebar">
    <i class="fas fa-bars"></i>
  </button>

  <!-- Main Navigation -->
  <nav class="sidebar-nav" id="sidebarNav">
    <ul class="nav flex-column">
      <!-- Core Navigation (not collapsible) -->
      <li class="nav-section-header">
        <span class="section-title">Main</span>
      </li>
      <li class="nav-item">
        <a
          class="nav-link {% if request.resolver_match.url_name == 'index' and request.resolver_match.namespace == 'home' %}active{% endif %}"
          href="{% url 'home:index' %}"
          data-tooltip="Home"
        >
          <i class="fas fa-home nav-icon"></i>
          <span class="nav-label">Home</span>
        </a>
      </li>

      <!-- Personnel Management Section -->
      <li
        class="nav-section-header collapsible-header"
        tabindex="0"
        data-target="personnel-section"
        aria-expanded="false"
      >
        <span class="section-title">Personnel Management</span>
        <i class="fas fa-chevron-down collapse-caret"></i>
      </li>
      <ul class="collapse-section" id="personnel-section" style="display: none">
        <li class="nav-item">
          <a
            class="nav-link {% if 'users' in request.resolver_match.namespace %}active{% endif %}"
            href="{% url 'users:index' %}"
            data-tooltip="Users"
          >
            <i class="fas fa-users nav-icon"></i>
            <span class="nav-label">Users</span>
          </a>
        </li>
        <li class="nav-item">
          <a
            class="nav-link {% if request.resolver_match.url_name == 'supervision' %}active{% endif %}"
            href="{% url 'va_analytics:supervision' %}"
            data-tooltip="Supervision"
          >
            <i class="fas fa-eye nav-icon"></i>
            <span class="nav-label">Supervision</span>
          </a>
        </li>
      </ul>

      <!-- Data Management Section -->
      <li
        class="nav-section-header collapsible-header"
        tabindex="0"
        data-target="data-section"
        aria-expanded="false"
      >
        <span class="section-title">Data Management</span>
        <i class="fas fa-chevron-down collapse-caret"></i>
      </li>
      <ul class="collapse-section" id="data-section" style="display: none">
        <li class="nav-item">
          <a
            class="nav-link {% if request.resolver_match.url_name == 'households' %}active{% endif %}"
            href="{% url 'va_data_management:households' %}"
            data-tooltip="Households"
          >
            <i class="fas fa-home nav-icon"></i>
            <span class="nav-label">Households</span>
          </a>
        </li>
        <li class="nav-item">
          <a
            class="nav-link {% if request.resolver_match.url_name == 'pregnancies' %}active{% endif %}"
            href="{% url 'va_data_management:pregnancies' %}"
            data-tooltip="Pregnancies"
          >
            <i class="fas fa-female nav-icon"></i>
            <span class="nav-label">Pregnancies</span>
          </a>
        </li>
        <li class="nav-item">
          <a
            class="nav-link {% if request.resolver_match.url_name == 'pregnancy_outcomes' %}active{% endif %}"
            href="{% url 'va_data_management:pregnancy_outcomes' %}"
            data-tooltip="Pregnancy Outcomes"
          >
            <i class="fas fa-baby nav-icon"></i>
            <span class="nav-label">Pregnancy Outcomes</span>
          </a>
        </li>
        <li class="nav-item">
          <a
            class="nav-link {% if request.resolver_match.url_name == 'deaths' %}active{% endif %}"
            href="{% url 'va_data_management:deaths' %}"
            data-tooltip="Deaths"
          >
            <i class="fas fa-skull-crossbones nav-icon"></i>
            <span class="nav-label">Deaths</span>
          </a>
        </li>
        <li class="nav-item">
          <a
            class="nav-link {% if request.resolver_match.url_name == 'index' and request.resolver_match.namespace == 'va_data_management' %}active{% endif %}"
            href="{% url 'va_data_management:index' %}"
            data-tooltip="Data Management"
          >
            <i class="fas fa-cog nav-icon"></i>
            <span class="nav-label">Verbal Autopsies</span>
          </a>
        </li>
        <li class="nav-item">
          <a
            class="nav-link {% if 'va_data_cleanup' in request.resolver_match.namespace %}active{% endif %}"
            href="{% url 'va_data_cleanup:index' %}"
            data-tooltip="Data Cleanup"
          >
            <i class="fas fa-broom nav-icon"></i>
            <span class="nav-label">Data Cleanup</span>
          </a>
        </li>
        <li class="nav-item">
          <a
            class="nav-link {% if 'va_export' in request.resolver_match.namespace %}active{% endif %}"
            href="{% url 'va_export:download_form' %}"
            data-tooltip="Export"
          >
            <i class="fas fa-download nav-icon"></i>
            <span class="nav-label">Data Export</span>
          </a>
        </li>
      </ul>

      <!-- Case Management Section -->
      <li
        class="nav-section-header collapsible-header"
        tabindex="0"
        data-target="case-section"
        aria-expanded="{% if '/case-management' in request.path %}true{% else %}false{% endif %}"
      >
        <span class="section-title">Case Management</span>
        <i class="fas fa-chevron-down collapse-caret"></i>
      </li>
      <ul
        class="collapse-section"
        id="case-section"
        style="{% if '/case-management' in request.path %}display:block{% else %}display:none{% endif %}"
      >
        <li class="nav-item">
          <a
            class="nav-link {% if request.resolver_match.url_name == 'cms-event-list' %}active{% endif %}"
            href="{% url 'cms-event-list' %}"
            data-tooltip="Events"
          >
            <i class="fas fa-calendar nav-icon"></i>
            <span class="nav-label">Events</span>
          </a>
        </li>
        <li class="nav-item">
          <a
            class="nav-link {% if request.resolver_match.url_name == 'cms-event-scheduled-list' %}active{% endif %}"
            href="{% url 'cms-event-scheduled-list' %}"
            data-tooltip="Data Management"
          >
            <i class="fas fa-person-walking-arrow-right nav-icon"></i>
            <span class="nav-label">Scheduled Events</span>
          </a>
        </li>
        <li class="nav-item">
          <a
            class="nav-link {% if request.resolver_match.url_name == 'cms-event-completed-list' %}active{% endif %}"
            href="{% url 'cms-event-completed-list' %}"
            data-tooltip="Data Management"
          >
            <i class="fas fa-book-skull nav-icon"></i>
            <span class="nav-label">Completed Events</span>
          </a>
        </li>
   
      </ul>

      <!-- Analytics Section -->
      <li
        class="nav-section-header collapsible-header"
        tabindex="0"
        data-target="analytics-section"
        aria-expanded="false"
      >
        <span class="section-title">Analytics</span>
        <i class="fas fa-chevron-down collapse-caret"></i>
      </li>
      <ul class="collapse-section" id="analytics-section" style="display: none">
        <li class="nav-item">
          <a
            class="nav-link {% if request.resolver_match.url_name == 'dashboard' %}active{% endif %}"
            href="{% url 'va_analytics:dashboard' %}"
            data-tooltip="Dashboard"
          >
            <i class="fas fa-chart-line nav-icon"></i>
            <span class="nav-label">Dashboard</span>
          </a>
        </li>
      </ul>

      <!-- Info Section -->
      <li class="nav-section-header">
        <span class="section-title">Info</span>
      </li>
      <li class="nav-item">
        <a
          class="nav-link {% if request.resolver_match.url_name == 'about' %}active{% endif %}"
          href="{% url 'home:about' %}"
          data-tooltip="About"
        >
          <i class="fas fa-info-circle nav-icon"></i>
          <span class="nav-label">About</span>
        </a>
      </li>
    </ul>
  </nav>
</div>

<!-- Overlay for mobile -->
<div class="sidebar-overlay" id="sidebarOverlay"></div>

<script>
document.addEventListener("DOMContentLoaded", function () {
  const sidebar = document.getElementById("sidebar");
  const sidebarToggle = document.getElementById("sidebarToggle");
  const sidebarOverlay = document.getElementById("sidebarOverlay");
  const headers = document.querySelectorAll(".collapsible-header");

  // --- Initialize collapsible sections with saved state ---
  headers.forEach(header => {
    const targetId = header.getAttribute("data-target");
    const section = document.getElementById(targetId);

    // Load saved state (if any), else use existing aria-expanded
    const saved = localStorage.getItem("sa_section_" + targetId);
    const initiallyExpanded = saved !== null ? (saved === "true")
      : (header.getAttribute("aria-expanded") === "true");

    header.setAttribute("aria-expanded", initiallyExpanded ? "true" : "false");
    if (section) section.style.display = initiallyExpanded ? "block" : "none";

    // Click + keyboard handlers
    header.addEventListener("click", () => {
      const isExpanded = header.getAttribute("aria-expanded") === "true";
      header.setAttribute("aria-expanded", isExpanded ? "false" : "true");
      if (section) section.style.display = isExpanded ? "none" : "block";
      localStorage.setItem("sa_section_" + targetId, (!isExpanded).toString());
    });

    header.addEventListener("keydown", function (e) {
      if (e.key === "Enter" || e.key === " ") {
        e.preventDefault();
        header.click();
      }
    });
  });

  // --- Restore sidebar collapsed state on desktop ---
  if (localStorage.getItem("sa_sidebarCollapsed") === "true") {
    sidebar.classList.add("collapsed");
  }

  // Helper to update the toggle icon (fa-bars <-> fa-times)
  function updateToggleIcon() {
    const icon = sidebarToggle.querySelector("i");
    if (!icon) return;

    if (window.innerWidth <= 995) {
      // mobile: show X when open, bars when closed
      if (sidebar.classList.contains("open")) {
        icon.classList.remove("fa-bars");
        icon.classList.add("fa-times");
      } else {
        icon.classList.remove("fa-times");
        icon.classList.add("fa-bars");
      }
    } else {
      // desktop: show X when expanded (not collapsed), bars when collapsed
      if (sidebar.classList.contains("collapsed")) {
        icon.classList.remove("fa-times");
        icon.classList.add("fa-bars");
      } else {
        icon.classList.remove("fa-bars");
        icon.classList.add("fa-times");
      }
    }
  }

  // --- Toggle behavior ---
  sidebarToggle.addEventListener("click", function () {
    if (window.innerWidth <= 995) {
      // Mobile: open/close the off-canvas sidebar (don't change collapsed state)
      const isNowOpen = sidebar.classList.toggle("open");
      sidebarOverlay.classList.toggle("active", isNowOpen);
    } else {
      // Desktop: collapse/expand (icon-only)
      const isCollapsed = sidebar.classList.toggle("collapsed");
      localStorage.setItem("sa_sidebarCollapsed", isCollapsed.toString());
    }
    updateToggleIcon();
  });

  // Clicking overlay closes the mobile sidebar
  sidebarOverlay.addEventListener("click", function () {
    sidebar.classList.remove("open");
    this.classList.remove("active");
    updateToggleIcon();
  });

  // Update icon on resize (keeps visual state consistent)
  window.addEventListener("resize", function () {
    // If resizing to desktop, ensure overlay/open classes are cleared
    if (window.innerWidth > 995) {
      sidebar.classList.remove("open");
      sidebarOverlay.classList.remove("active");
    }
    updateToggleIcon();
  });

  // initial icon set
  updateToggleIcon();
});
</script>


