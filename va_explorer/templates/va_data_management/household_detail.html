{% extends "base.html" %}
{% load static i18n %}
{% load va_explorer_tags %}

{% block title %}Household #{{ object.id }}{% endblock %}
{% block heading %}Household #{{ object.id }}{% endblock %}

{% block content %}
<ul class="nav nav-tabs tab-spacing" id="myTab" role="tablist">
  <li class="nav-item">
    <a class="nav-link active" id="record-tab" data-toggle="tab" href="#record" role="tab" aria-controls="record" aria-selected="true">Household</a>
  </li>
   <li class="nav-item">
    <a class="nav-link" id="members-tab" data-toggle="tab" href="#members" role="tab" aria-controls="members" aria-selected="false">Members</a>
  </li>
  <li class="nav-item">
    <a class="nav-link" id="issues-tab" data-toggle="tab" href="#issues" role="tab" aria-controls="issues" aria-selected="false">Issues</a>
  </li>
  {% if diffs and not user.is_fieldworker %}
    <li class="nav-item">
      <a class="nav-link" id="history-tab" data-toggle="tab" href="#history" role="tab" aria-controls="history" aria-selected="false">Change History</a>
    </li>
  {% endif %}
</ul>

<div class="tab-content">
  <div class="tab-pane fade show active" id="record" role="tabpanel" aria-labelledby="record-tab">
    <div class="row mt-3">
      <div class="va-options-container">
        <div class="checkbox-container" align='center'>
          <input class="checkbox" type="checkbox" id="hidden-missing" name="hidden-missing" value="checked" checked="TRUE">
          <label class="checkbox-label"
                data-toggle="tooltip"
                title="Toggle whether or not you want to see fields with 'N/A' or '' as responses. When unchecked, these blank responses will be shown."
                for="hidden-missing">
                Hide Empty Fields
          </label><br>
          {% if not user.can_view_pii %}
          <input class="checkbox" type="checkbox" id="hidden-redacted" name="hidden-redacted">
          <label class="checkbox-label"
                data-toggle="tooltip"
                title="Toggle whether or not you want to see redacted fields."
                for="hidden-redacted">
                Hide Redacted Fields
          </label><br>
          {% endif %}
        </div>
        {% if perms.va_data_management.change_household %}
        <div>
          <a style="text-align:center;" class="btn btn-primary" href="{% url 'va_data_management:household_edit' id=id %}">Edit Record</a>
        </div>
        {% endif %}
      </div>
    </div>

    <div class="row mt-4">
      <table class="table table-hover table-sm">
        <thead>
          <tr>
            <th>Field Name</th>
            <th>Field Question</th>
            <th>Value</th>
          </tr>
        </thead>
        <tbody>
          {% for field in form %}
            <tr data-value="{% pii_filter field.name field.value|replace %}">
              <td><b>{{ field.name }}</b></td>
              <td>{{ field.label }}</td>
              <td>
                {% pii_filter field.name field.value|replace %}
              </td>
            </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  </div>
  <div class="tab-pane fade" id="members" role="tabpanel" aria-labelledby="members-tab">
    <div class="row mt-4">
      {% if object.members.all %}
        <table class="table table-hover table-sm">
          <thead>
            <tr>
              <th>ID</th>
              <th>First Name</th>
              <th>Surname</th>
              <th>Sex</th>
              <th>Age</th>
              <th>Relationship to Head</th>
            </tr>
          </thead>
          <tbody>
            {% for member in object.members.all %}
              <tr>
                <td>{{ member.id }}</td>
                <td>{{ member.first_name|default:"-" }}</td>
                <td>{{ member.last_name|default:"-" }}</td>
                <td>{{ member.HH_05|default:"-" }}</td>
                <td>{{ member.HH_08|default:"-" }}</td>
                <td>{{ member.HH_04|default:"-" }}</td>
              </tr>
            {% endfor %}
          </tbody>
        </table>
      {% else %}
        <p class="mx-3">There are no household members listed for this household.</p>
      {% endif %}
    </div>
  </div>

  <div class="tab-pane fade" id="issues" role="tabpanel" aria-labelledby="issues-tab">
  <div class="row mt-4">
    {% if dq_issues and dq_issues|length > 0 %}
      <div class="col-12 mb-2">
        <span class="badge badge-danger mr-2">Open: {{ dq_issues_counts.open }}</span>
        <span class="badge badge-success mr-2">Resolved: {{ dq_issues_counts.resolved }}</span>
        <span class="badge badge-secondary">Muted: {{ dq_issues_counts.muted }}</span>
      </div>

      <table class="table table-hover table-sm">
        <thead>
          <tr>
            <th>#</th>
            <th>Type</th>
            <th>Status</th>
            <th>Title</th>
            <th>Detected</th>
            <th>Updated</th>
            <th>Keys</th>
            <th>Details</th>
          </tr>
        </thead>
        <tbody>
          {% for issue in dq_issues %}
            <tr>
              <td>{{ forloop.counter }}</td>
              <td>{{ issue.get_issue_type_display }}</td>
              <td>
                {% if issue.status == 'open' %}
                  <span class="badge badge-danger">Open</span>
                {% elif issue.status == 'resolved' %}
                  <span class="badge badge-success">Resolved</span>
                {% else %}
                  <span class="badge badge-secondary">Muted</span>
                {% endif %}
              </td>
              <td>{{ issue.title|default:"â€”" }}</td>
              <td>{{ issue.detected_at|date:"Y-m-d H:i" }}</td>
              <td>{{ issue.updated|date:"Y-m-d H:i" }}</td>
              <td><code style="white-space: pre-wrap;">{{ issue.keys }}</code></td>
              <td><code style="white-space: pre-wrap;">{{ issue.details }}</code></td>
            </tr>
          {% endfor %}
        </tbody>
      </table>
    {% else %}
      <p class="mx-3">No data quality issues detected for this record.</p>
    {% endif %}
  </div>
</div>

  {% if diffs and not user.is_fieldworker  %}
    <div class="tab-pane fade" id="history" role="tabpanel" aria-labelledby="history-tab">
      <div class="row mt-4">
        <table class="table table-hover table-sm">
          <thead>
            <tr>
              <th colspan=3>{{ diffs|length }} Change{{ diffs|pluralize }}</th>
            </tr>
          </thead>
          <tbody>
            {% for diff in diffs %}
              <tr>
                <td>{{ diff.new_record.history_date|date:"Y-m-d H:i" }}</td>
                <td>{{ diff.new_record.history_user.name|default:"System" }} &lt;{{ diff.new_record.history_user.email|default:"noreply@host" }}&gt;</td>
                <td>
                  {% for change in diff.changes %}
                    {% if change.old and change.new %}
                      <b>{{ change.field }}</b> changed from <b>{% pii_filter change.field change.old %}</b> to <b>{% pii_filter change.field change.new %}</b><br/>
                    {% elif change.new %}
                      <b>{{ change.field }}</b> was set to <b>{% pii_filter change.field change.new %}</b><br/>
                    {% elif change.old %}
                      <b>{{ change.field }}</b> had value <b>{% pii_filter change.field change.old %}</b> deleted<br/>
                    {% endif %}
                  {% endfor %}
                </td>
              </tr>
            {% endfor %}
        </table>
      </div>
      <div class="row mt-4">
        {% if perms.va_data_management.change_household %}
          <a class="btn btn-primary mx-2" href="{% url 'va_data_management:household_reset' id=id %}">Reset to Original</a></p>
          <a class="btn btn-primary mx-2" href="{% url 'va_data_management:household_revert_latest' id=id %}">Revert Most Recent Change</a>
        {% endif %}
      </div>
    </div>
  {% endif %}
</div>

<div class="flt-action-backdrop"></div>
<div class="flt-action-btn child to-top" data-subitem="3"><i class="fas fa-caret-up"></i></div>
<div class="flt-action-btn child to-bottom" data-subitem="2"><i class="fas fa-caret-down"></i></div>
<a href="{% url 'va_data_management:households' %}">
  <div class="flt-action-btn child" data-subitem="1"><i class="fas fa-angle-double-left"></i></div>
</a>
<div class="flt-action-btn" id="main-fab"><i class="fas fa-sort"></i></div>
{% endblock %}

{% block page_scripts %}
  <script src="{% static 'js/fab.js' %}"></script>
{% endblock %}
